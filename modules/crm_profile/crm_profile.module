<?php

/**
 * @file
 * Support for configurable user profiles which are not attached to users.
 */
 
/**
 * Implements hook_menu()
 *
 * Define a page to edit a profile in place.
 */
function crm_profile_menu() {
  // @todo: not sure we should be fiddling with profile's menu stuff!
  $items['profile/%profile2/edit'] = array(
    'title' => 'Edit Profile',
    'page callback' => 'profile_page_edit',
    'page arguments' => array(1),
    'access callback' => 'profile2_access',
    'access arguments' => array('update', 1),
    'file' => 'crm_profile.pages.inc',
  );
  $items['party/%crm_party/add/%profile2_type'] = array(
    'title' => 'Add Profile',
    'page callback' => 'profile_page_add',
    'page arguments' => array(1,3),
    'access callback' => 'profile2_access',
    'access arguments' => array('create',3),
    'file' => 'crm_profile.pages.inc',
  );
  return $items;
}

/**
 * Implements hook_enitity_info_alter()
 *
 * Add a new view mode to profile2's for parties
 */
function crm_profile_entity_info_alter(&$entity_info) {
  $entity_info['profile2']['view modes']['party'] = array(
    'label' => t('Party Display'),
    'custom settings' => false,
  );
}

/**
 * Implements hook_preprocess_HOOK()
 * 
 * Lets add a new tpl for party display
 */
function crm_profile_preprocess_entity(&$vars) {
  //Add a new profile view tpl.
  if ($vars['view_mode'] == 'party') {
    $vars['theme_hook_suggestions'][] = 'profile2__all__party';
  }
}

/**
 * Implements hook_form_FORM_ID_alter()
 *
 * Alter Party forms to do things
 */
function crm_profile_form_crm_party_edit_form_alter(&$form, &$form_state, $form_id) {
  // Make sure the uid is null. 
  $form['uid'] = array(
    '#type' => 'hidden',
    '#value' => null,
  );  
  
  $profiles = array();
  if (isset($form['pid'])) {
    $profiles = _crm_profile_load_by_party($form['pid']['#value']);
  }  
  
  // Load appropriate profile2s and attach them to the party form
  foreach (profile2_get_types() as $type_name => $profile_type) {
    if (isset($profiles[$type_name])) {
      $form_state['profiles'][$type_name] = $profiles[$type_name];
    }
    
    if (empty($form_state['profiles'][$type_name])) {
      $form_state['profiles'][$type_name] = profile_create(array('type' => $type_name));
    }
    profile2_attach_form($form, $form_state);
    // Wrap each profile form in a fieldset.
    $form['profile_' . $type_name] += array(
      '#type' => 'fieldset',
      '#title' => check_plain($profile_type->label),
    );
  }
  
  $form['#submit'][] = 'crm_profile_post_form_submit_relate';
}

/**
 * Relate the profile2 entities to the crm_party in form_state
 */
function crm_profile_post_form_submit_relate($form, &$form_state) {
  $party = $form_state['crm_party'];
  $profiles = array();
  
  foreach (profile2_get_types() as $type_name => $profile_type) {
    if (isset($form_state['profiles'][$type_name])) {
      $profiles[] = $form_state['profiles'][$type_name];
    } 
    else {
      $thisProfile = profile_create(array('type' => $type_name, 'uid' => null));
      profile2_save($thisProfile);
      $profiles[] =  $thisProfile;
    } 
  }
  
  // Foreach profile2 in the form state add a binary relation linking it
  // to the party
  foreach ($profiles as $profile) {
    _crm_party_profile_relate($party, $profile);
  }
}

/**
 * Relate a party entity to a profile2 entity
 *
 * @param $party
 *   A fully loaded party object, from crm_party_load(). Whats important is that the pid is correct.
 * @param $profile
 *   A profile2 object
 */
function _crm_party_profile_relate($party, $profile) {
  $endpoints = array();
  $endpoints[] = array(
    'entity_type' => 'crm_party',
    'entity_id' => $party->pid,
  );
  $endpoints[] = array(
    'entity_type' => 'profile2',
    'entity_id' => $profile->pid,
  );
  
  //create a relation for each party profile2 which is created.
  $relation = relation_create('party_to_profile2_'.$profile->type, $endpoints);
  $rid = relation_save($relation);

  //set some nice messages - change
  drupal_set_message('Party: ' . $party->label . ' has been related to Profile: ' . $profile->pid);
}

/**
 * Change the Party Details Page
 *
 * @param $party
 *   A party object.
 *
 * @return 
 *   An array
 */
function crm_profile_crm_party_page_view_alter($party) {
  $build = array();
  $allProfiles = _crm_profile_load_by_party($party);
  foreach ($allProfiles as $type => $profiles) {
    //as $profiles could be a list of profiles we need to standardise what we're dealing with.
    if (is_object($profiles)) {
      $temp = $profiles;
      $profiles = array();
      $profiles[] = $temp;
    }
    foreach ($profiles as $profile) {
      _crm_profile_is_null($profile);
      if (!$profile->is_null && profile2_access('view', $profile)) {
        $profile->this_party = $party;
        
        $build['profile_' . $profile->pid] = array(
          '#type' => 'fieldset',
          '#title' => $profile->label,
        );
        $build['profile_' . $profile->pid]['view'] = $profile->view('party');
      }
    }
    $build['profile_' . $type . '_add']['#markup'] = "<div class=\"clearfix\">
      <div class=\"crm_profile_ops\" style=\"float: right\">".l("Add " . reset($profiles)->label, 'party/' . $party->pid . '/add/' . $type)."
        </div>
      </div>";
  }
  
  return $build;
}

/**
 * Implements hook_entity_insert().
 *
 * Make the right relation when a profile type is added.
 */
function crm_profile_entity_insert($entity, $type) {
  if ($type == 'profile2_type') {  
    // Create the null profile.
    $profile = profile_create(array('type' => $entity->type, 'uid' => null));
    profile2_save($profile);
      
    $data = array(
      'type' => $entity->type,
      'pid' => $profile->pid,
    );
    drupal_write_record('crm_profile_null', $data);

    //Create a relation type
    $relation_type = array(
      'relation_type' => 'party_to_profile2_'.$entity->type,
      'label' => 'Party to Profile '.$entity->label,
      'max_arity' => 2,
      'source_bundles' => array(
        'crm_party:*',
        'profile2:'.$entity->type,
      ),
    );
    
    relation_type_save($relation_type); 
    drupal_set_message("Contact to Profile ".$entity->label." Created");
    
    //TODO: Relate every existing party to this null profile;
    $query = db_select('crm_party', 'cp');
    $query->fields('cp');
    $result = $query->execute();
    
    while($record = $result->fetchAssoc()) {
      //this is cheating so we can use another function, probably the function needs to be fixed
      $party = new stdClass();
      $party->pid = $record['pid'];
      $party->label = $record['label'];
      
      _crm_party_profile_relate($party, $profile);
    }
  }
}


/**
 * Load all the profiles for a given party. 
 *
 * @param $party
 *   Either a party object or the id of a party.
 *
 * @return 
 *  An array of profiles attached to this party of the for ['type'][] = $profile;
 */
function _crm_profile_load_by_party($party) {
  // Get the pid from whatever is passed.
  $pid = is_object($party) ? $party->pid : $party;
  $profiles = array();
  
  foreach (profile2_get_types() as $type_name => $profile_type) {
    $raw = relation_get_related_entities('crm_party', $pid, 'party_to_profile2_' . $type_name);
    foreach ($raw as $relation) {
      foreach ($relation as $profile) {
        $profiles[$type_name][] = $profile;
      }
    }

    if (isset($profiles[$type_name]) && count($profiles[$type_name]) == 1) {
      $profiles[$type_name] = reset($profiles[$type_name]);
    }
  } 
  return $profiles;
}

/**
 * Load all parties related to a given profile.
 *
 * @param $profile
 *   Either a profile2 object or the id of a profile.
 */
function _crm_profile_load_parties($profile) {
  $pid = is_object($profile) ? $profile->pid : $profile;
  $parties = array();
  
  $raw = relation_get_related_entities('profile2', $pid, 'party_to_profile2_' . $profile->type);
  foreach ($raw as $relation) {
    foreach ($relation as $party) {
      $parties[$party->pid] = $party;
    }
  }
  
  return($parties);
}

/**
 * Find out if a profile is a null profile.
 */
function _crm_profile_is_null(&$profile) {
  $query = db_select('crm_profile_null');
  $query->condition('pid', $profile->pid, '=');
  $query = $query->countQuery();
  $result = $query->execute();
  $record = $result->fetchAssoc();
  
  if ($record['expression'] == '1') {
    $profile->is_null = TRUE;
  }
  else {
    $profile->is_null = FALSE;
  }
}


