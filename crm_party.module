<?phpinclude_once("includes/crm_party.entity.inc");include_once("includes/crm_party_type.entity.inc");/** * Implement hook_entity_info(). * * Define 2 entities here - the actual entity that will hold our domain  * specific information and an entity that holds information about the  * different types of entities. */function crm_party_entity_info(){  $party_info['crm_party'] = array(    'label' => t('Contact'),    'entity class' => 'CRMParty',    'controller class' => 'CRMPartyController',    'base table' => 'crm_party',    //'uri callback' => 'crm_party_uri',    'fieldable' => TRUE,    'module' => 'crm_party',    'entity keys' => array(      'id' => 'pid',      'bundle' => 'type',    ),    //'static cache' => TRUE,    'bundles' => array(),    'bundle keys' => array(      'bundle' => 'type',    ),    'label callback' => 'entity_class_label',    'view modes' => array(      'full' => array(        'label' => t('Full Contact'),        'custom settings' =>  FALSE,      ),    )  );    $party_info['crm_party_type'] = array(    'label' => t('Party Type'),    'entity class' => 'CRMPartyType',    'controller class' => 'CRMPartyTypeController',    'base table' => 'crm_party_type',    'fieldable' => FALSE,    'bundle of' => 'crm_party',    'exportable' => TRUE,    'entity keys' => array(      'id' => 'ptid',      'name' => 'type',      'label' => 'label',    ),    'module' => 'crm_party',    'admin ui' => array(      'path' => 'admin/community/structure/party_types',      'file' => 'crm_party_type.entity.inc',      'controller class' => 'CRMPartyTypeUIController',    ),  );    return $party_info;}/** * Implements hook_entity_info_alter(). * * We are adding the info about the model types via a hook to avoid a recursion * issue as loading the model types requires the entity info as well. * * @todo This needs to be improved */function crm_party_entity_info_alter(&$entity_info) {  foreach (crm_party_get_types() as $type => $info) {    $entity_info['crm_party']['bundles'][$type] = array(      'label' => $info->label,      'admin' => array(        'path' => 'admin/community/structure/party_types/manage/%crm_party_type',        'real path' => 'admin/community/structure/party_types/manage/' . $type,        'bundle argument' => 4,        'access arguments' => array('administer party types'),      ),    );  }}/** * Define some pages */function crm_party_menu() {  $items['admin/community/party/manage'] = array(    'title' => 'Contact Admin',    'description' => 'Manage Contact Information',    'page callback' => 'crm_party_info',    'access arguments' => array('administer parties'),  );  $items['party/%crm_party'] = array(    'title callback' => 'crm_party_page_title',    'title arguments' => array(1),    'page callback' => 'crm_party_page_view',    'page arguments' => array(1),    'access arguments' => array('view contacts'),    'type' => MENU_CALLBACK,  );  $items['party/%crm_party/edit'] = array(    'title callback' => 'crm_party_edit_page_title',    'title arguments' => array(1),    'page callback' => 'drupal_get_form',    'page arguments' => array('crm_party_edit_form', 1),    'access arguments' => array('edit contacts'),    'type' => MENU_CALLBACK,  );  $items['party/add'] = array(    'title' => 'Add Contact',    'page callback' => 'crm_party_add',    'access arguments' => array('create contacts'),  );    //party type pages  $items['admin/community/structure/parties'] = array(    ); //TODO explicitly state links.  return $items;}/** * Access callback */function crm_party_permission(){    return array(    'administer party types' => array(      'title' => t('Administer Party Types'),      'restrict access' => TRUE,    ),    'administer parties' =>  array(      'title' => t('Administer Parties'),      'restrict access' => TRUE,    ),    'create parties' => array(      'title' => t('Create Parties'),    ),    'view parties' => array(      'title' => t('View Parties'),    ),    'edit parties' => array(      'title' => t('Edit Parties'),    )  );}/** * URI callback for contacts */function crm_party_uri($party) {  return array('path' => 'party/'.$party->pid , );}/** * */function crm_party_theme() {  return array(    'crm_party_email' => array(      'variables' => array('crm_party_email', 'crm_party' => Null),      'template' => 'crm_party_email',    ),  );}/** * Load a single contact */function crm_party_load($pid = NULL, $reset = FALSE){  $pids = (isset ($pid) ? array($pid) : array());  $party = crm_party_load_multiple($pids, $reset);  return $party ? reset ($party) : FALSE;}/** * Load many contacts */ function crm_party_load_multiple($pids = array(), $conditions = array(), $reset = FALSE){  return entity_load('crm_party', $pids, $conditions, $reset);}/** * pages - to be moved to a different file */function crm_party_info() {  return "Welcome to the contact info administration page";}function crm_party_page_title($party) {  return $party->label;}function crm_party_page_view($party, $view_mode = 'full') {  $party->content = array();    $controller = entity_get_controller('crm_party');    $content = $controller->view(array($party->pid => $party));  drupal_set_title($party->label);  return $content;    }function crm_party_edit_page_title($party) {  return "Edit " . $party->label;} /** * Add Contact Page */function crm_party_add() {  $party = (object) array(    'type' => 'crm_party',    'label' => '',  );      return drupal_get_form('crm_party_edit_form', $party);}function crm_party_edit_form($form, &$form_state, $party) {  if(isset($party->pid)) {    $form['pid'] = array(      '#type' => 'value',      '#value' => $party->pid,    );  }    $form['label'] = array(    '#type' => 'textfield',    '#title' => t('Party Label'),    '#required' => TRUE,    '#default_value' => $party->label,  );    field_attach_form('crm_party', $party, $form, $form_state);    $form['submit'] = array(    '#type' => 'submit',    '#value' => t('Save'),    '#weight' => 99,  );  return $form;}function crm_party_edit_form_validate($form, &$form_state) {  $submission = (object) $form_state['values'];  field_attach_form_validate('crm_party', $submission, $form, $form_state);  }function crm_party_edit_form_submit($form, &$form_state) {  $party = (object) $form_state['values'];  field_attach_submit('crm_party', $party, $form, $form_state);  $party = crm_party_save($party);  $form_state['redirect'] = 'party/' . $party->pid;}/** * Delete a contact */function crm_party_delete(CRMParty $party) {  $party->delete();}/** * Save a contact */function crm_party_save(&$party) {  return entity_get_controller('crm_party')->save($party);}function crm_party_field_extra_fields() {  $return = array();  /*$return['crm_party']['crm_party'] = array(    'form' => array(      'email' => array(        'label' => t('Email'),        'description' => t('Tribes Contact Email'),      ),    ),    'display' => array(      'email' => array(        'label' => t('Email'),        'description' => t('Tribes Contact Email'),      ),    ),  );*/  return $return;}// Party Type things/** * Gets an array of all model types, keyed by the type name. * * @param $type_name *   If set, the type with the given name is returned. * @return ModelType[] *   Depending whether $type isset, an array of model types or a single one. */function crm_party_get_types($type_name = NULL) {  // entity_load will get the Entity controller for our crm part entity and call the load  // function of that object - we are loading entities by name here.  $types = entity_load_multiple_by_name('crm_party_type', isset($type_name) ? array($type_name) : FALSE);  return isset($type_name) ? reset($types) : $types;}/** * Menu argument loader; Load a model type by string. * * @param $type *   The machine-readable name of a model type to load. * @return *   A model type array or FALSE if $type does not exist. */function crm_party_type_load($type) {  return crm_party_get_types($type);}/** * Saves a model type to the db. */function crm_party_type_save(CRMPartyType $type) {  $type->save();}/** * Deletes a model type from the db. */function crm_party_type_delete(CRMP $type) {  $type->delete();}